@page "/editsickleave/{Id:int}"
@using Tutel.EduWork.BusinessLayer.Abstractions
@using Tutel.EduWork.BusinessLayer.DTOs

@inject ISickLeaveService sickLeaveService
@inject IUserService userService
@inject NavigationManager NavigationManager

<h3>Uredi bolovanje</h3>

@if (sickLeave == null || users == null)
{
    <p>Učitavanje...</p>
}
else
{
    <EditForm Model="@sickLeave" OnValidSubmit="HandleEdit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Datum početka</label>
            <InputDate @bind-Value="sickLeave.StartDate" class="form-control" />
        </div>
        <div class="mb-3">
            <label class="form-label">Datum kraja</label>
            <InputDate @bind-Value="sickLeave.EndDate" class="form-control" />
        </div>
        <div class="mb-3">
            <label class="form-label">Razlog bolovanja</label>
            <InputText @bind-Value="sickLeave.Reason" class="form-control" />
        </div>
        <div class="mb-3">
            <label class="form-label">Korisnik</label>
            <select class="form-select" @bind="sickLeave.UserId">
                <option value="">-- Odaberi korisnika --</option>
                @foreach (var user in users)
                {
                    <option value="@user.Id">@user.FullName</option>
                }
            </select>
        </div>

        <button type="submit" class="btn btn-success">Spremi</button>
        <button type="button" class="btn btn-secondary ms-2" @onclick="GoBack">Natrag</button>
    </EditForm>
    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert @alertClass mt-3">@message</div>
    }
}

@code {
    [Parameter] public int Id { get; set; }
    private SickLeaveDTO? sickLeave;
    private List<UserDTO>? users;
    private string message = "";
    private string alertClass = "";

    protected override async Task OnInitializedAsync()
    {
        users = await userService.GetAllAsync();
        sickLeave = await sickLeaveService.Get(Id);
    }

    private async Task HandleEdit()
    {
        try
        {
            await sickLeaveService.UpdateAsync(sickLeave!);
            message = "Uspješno ažurirano!";
            alertClass = "alert-success";
            await Task.Delay(1200);
            NavigationManager.NavigateTo("/timeoff");
        }
        catch (Exception ex)
        {
            message = $"Greška: {ex.Message}";
            alertClass = "alert-danger";
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/timeoff");
    }
}
